---
import BaseLayout from '@layouts/BaseLayout.astro';
import PortableTextRenderer from '@components/PortableTextRenderer.astro';
import BlogCard from '@components/BlogCard.astro';
import JsonLd from '@components/JsonLd.astro';
import { getPostBySlug, getAllPostSlugs, getFeaturedPosts } from '@lib/sanityQueries';
import { urlFor, getImageDimensions } from '@lib/sanity';
import type { BlogPost, BlogPostPreview } from '@types/sanity';

// Generate static paths for all blog posts
export async function getStaticPaths() {
  const slugs = await getAllPostSlugs();
  
  return slugs.map((slug) => ({
    params: { slug },
  }));
}

// Get the post data
const { slug } = Astro.params;
let post: BlogPost | null = null;
let relatedPosts: BlogPostPreview[] = [];

try {
  post = await getPostBySlug(slug);
  
  if (post) {
    // Fetch related posts (posts from same categories, or just recent posts)
    const allRelated = await getFeaturedPosts(4);
    // Filter out current post and limit to 3
    relatedPosts = allRelated.filter(p => p._id !== post!._id).slice(0, 3);
  }
} catch (error) {
  console.error('Failed to fetch post:', error);
}

// Redirect to 404 if post not found
if (!post) {
  return Astro.redirect('/404');
}

// Format date helper
function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

// Calculate reading time and word count based on content
function getContentStats(content: any[]): { readingTime: string; wordCount: number } {
  if (!content || !Array.isArray(content)) return { readingTime: '5 min read', wordCount: 1000 };
  
  // Extract text from portable text blocks
  const text = content
    .filter(block => block._type === 'block')
    .map(block => block.children?.map((child: any) => child.text).join(' ') || '')
    .join(' ');
  
  const words = text.split(/\s+/).filter(word => word.length > 0).length;
  const minutes = Math.max(1, Math.round(words / 200));
  return { readingTime: `${minutes} min read`, wordCount: words };
}

const contentStats = getContentStats(post.content);

// Get featured image URL
const featuredImageUrl = post.featuredImage?.asset 
  ? urlFor(post.featuredImage).width(1600).height(900).auto('format').url()
  : null;

// Get OG image (slightly different dimensions for social sharing)
const ogImageUrl = post.featuredImage?.asset 
  ? urlFor(post.featuredImage).width(1200).height(630).auto('format').url()
  : null;

// Get featured image dimensions for responsive sizing
const featuredImageDimensions = post.featuredImage?.asset 
  ? getImageDimensions({ asset: post.featuredImage.asset })
  : null;

// Generate responsive srcset for hero image
const heroImageSrcset = post.featuredImage?.asset 
  ? [800, 1200, 1600, 2000]
      .map((width) => {
        const url = urlFor(post.featuredImage)
          .width(width)
          .auto('format')
          .quality(85)
          .url();
        return `${url} ${width}w`;
      })
      .join(', ')
  : '';

// Sizes attribute for hero image (full width up to max-w-5xl container)
const heroImageSizes = '(max-width: 640px) 100vw, (max-width: 1024px) 90vw, 1024px';

// Build author image URL
const authorImageUrl = post.author?.image?.asset
  ? urlFor(post.author.image).width(200).height(200).auto('format').url()
  : undefined;

// Get author's social links for sameAs
const authorSameAs = post.author?.socialLinks
  ? [
      post.author.socialLinks.twitter,
      post.author.socialLinks.linkedin,
      post.author.socialLinks.github,
      post.author.socialLinks.website,
    ].filter(Boolean) as string[]
  : [];

// Current page URL
const pageUrl = new URL(`/blog/${post.slug.current}`, Astro.site || 'https://jakubbarak.com').href;

// Build breadcrumb items
const breadcrumbItems = [
  { name: 'Home', url: Astro.site?.href || 'https://jakubbarak.com' },
  { name: 'Blog', url: new URL('/blog', Astro.site || 'https://jakubbarak.com').href },
  { name: post.title, url: pageUrl },
];

// Get category for article section
const articleSection = post.categories?.[0]?.title || 'Blog';
---

<BaseLayout 
  title={post.seo?.metaTitle || post.title}
  description={post.seo?.metaDescription || post.excerpt}
  image={ogImageUrl || undefined}
  ogType="article"
  publishedTime={post.publishedAt}
  modifiedTime={post._updatedAt}
>
  <!-- Structured Data: BlogPosting -->
  <JsonLd
    schema={[
      {
        type: 'BlogPosting',
        headline: post.title,
        description: post.excerpt || post.seo?.metaDescription,
        image: featuredImageUrl ? [featuredImageUrl, ogImageUrl].filter(Boolean) as string[] : undefined,
        datePublished: post.publishedAt,
        dateModified: post._updatedAt,
        url: pageUrl,
        mainEntityOfPage: pageUrl,
        wordCount: contentStats.wordCount,
        articleSection: articleSection,
        keywords: post.seo?.keywords || post.categories?.map(c => c.title),
        author: {
          type: 'Person',
          name: post.author?.name || 'Jakub Barak',
          url: post.author?.slug?.current 
            ? new URL(`/author/${post.author.slug.current}`, Astro.site || 'https://jakubbarak.com').href
            : Astro.site?.href || 'https://jakubbarak.com',
          image: authorImageUrl,
          description: post.author?.bio,
          sameAs: authorSameAs.length > 0 ? authorSameAs : undefined,
        },
      },
      {
        type: 'BreadcrumbList',
        items: breadcrumbItems,
      },
    ]}
  />
  
  <article class="py-12 md:py-20">
    <!-- Hero Section -->
    <header class="mb-12">
      <div class="mx-auto max-w-4xl px-4">
        <!-- Back Link -->
        <a 
          href="/blog"
          class="inline-flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors mb-8"
        >
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back to Blog
        </a>

        <!-- Categories -->
        {post.categories && post.categories.length > 0 && (
          <div class="flex flex-wrap gap-2 mb-4">
            {post.categories.map((category) => (
              <a 
                href={`/blog?category=${category.slug.current}`}
                class="text-sm font-medium text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 px-3 py-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
              >
                {category.title}
              </a>
            ))}
          </div>
        )}

        <!-- Title -->
        <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-900 dark:text-white leading-tight mb-6">
          {post.title}
        </h1>

        <!-- Excerpt -->
        {post.excerpt && (
          <p class="text-xl text-gray-600 dark:text-gray-400 leading-relaxed mb-8">
            {post.excerpt}
          </p>
        )}

        <!-- Meta Info -->
        <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500 dark:text-gray-400 pb-8 border-b border-gray-200 dark:border-gray-700">
          {/* Author */}
          {post.author && (
            <div class="flex items-center gap-3">
              {post.author.image?.asset ? (
                <img 
                  src={urlFor(post.author.image).width(48).height(48).auto('format').url()}
                  alt={post.author.name}
                  class="w-10 h-10 rounded-full object-cover"
                />
              ) : (
                <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                  <span class="text-sm font-medium text-gray-600 dark:text-gray-400">
                    {post.author.name.charAt(0).toUpperCase()}
                  </span>
                </div>
              )}
              <div>
                <div class="font-medium text-gray-900 dark:text-white">
                  {post.author.name}
                </div>
                {post.author.bio && (
                  <div class="text-xs text-gray-500 dark:text-gray-500 line-clamp-1">
                    {post.author.bio}
                  </div>
                )}
              </div>
            </div>
          )}

          <span class="hidden sm:block text-gray-300 dark:text-gray-600">•</span>

          {/* Date */}
          <time datetime={post.publishedAt} class="flex items-center gap-1.5">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            {formatDate(post.publishedAt)}
          </time>

          <span class="hidden sm:block text-gray-300 dark:text-gray-600">•</span>

          {/* Reading Time */}
          <span class="flex items-center gap-1.5">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {contentStats.readingTime}
          </span>
        </div>
      </div>

      <!-- Featured Image -->
      {featuredImageUrl && (
        <div class="mt-8 mx-auto max-w-5xl px-4">
          <figure>
            <div 
              class="relative overflow-hidden rounded-2xl shadow-xl bg-gray-100 dark:bg-gray-800"
              style={featuredImageDimensions ? `aspect-ratio: ${featuredImageDimensions.width} / ${featuredImageDimensions.height};` : 'aspect-ratio: 16 / 9;'}
            >
              <img 
                src={featuredImageUrl}
                srcset={heroImageSrcset}
                sizes={heroImageSizes}
                alt={post.featuredImage?.alt || post.title}
                class="w-full h-full object-cover"
                loading="eager"
                decoding="async"
                width={featuredImageDimensions?.width || 1600}
                height={featuredImageDimensions?.height || 900}
              />
            </div>
            {post.featuredImage?.caption && (
              <figcaption class="mt-3 text-center text-sm text-gray-500 dark:text-gray-400">
                {post.featuredImage.caption}
              </figcaption>
            )}
          </figure>
        </div>
      )}
    </header>

    <!-- Article Content -->
    <div class="mx-auto max-w-3xl px-4">
      <PortableTextRenderer content={post.content} class="article-content" />
    </div>

    <!-- Article Footer -->
    <footer class="mt-16 mx-auto max-w-4xl px-4">
      <!-- Tags/Categories -->
      {post.categories && post.categories.length > 0 && (
        <div class="py-8 border-t border-gray-200 dark:border-gray-700">
          <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3">
            Posted in
          </h3>
          <div class="flex flex-wrap gap-2">
            {post.categories.map((category) => (
              <a 
                href={`/blog?category=${category.slug.current}`}
                class="px-4 py-2 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 text-sm font-medium rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
              >
                {category.title}
              </a>
            ))}
          </div>
        </div>
      )}

      <!-- Author Bio -->
      {post.author && (
        <div class="py-8 border-t border-gray-200 dark:border-gray-700">
          <div class="flex items-start gap-4 sm:gap-6">
            {post.author.image?.asset ? (
              <img 
                src={urlFor(post.author.image).width(80).height(80).auto('format').url()}
                alt={post.author.name}
                class="w-16 h-16 sm:w-20 sm:h-20 rounded-full object-cover shrink-0"
              />
            ) : (
              <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center shrink-0">
                <span class="text-xl font-medium text-gray-600 dark:text-gray-400">
                  {post.author.name.charAt(0).toUpperCase()}
                </span>
              </div>
            )}
            <div>
              <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">
                Written by
              </h3>
              <p class="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                {post.author.name}
              </p>
              {post.author.bio && (
                <p class="text-gray-600 dark:text-gray-400 text-sm leading-relaxed">
                  {post.author.bio}
                </p>
              )}
              {post.author.socialLinks && (
                <div class="flex items-center gap-3 mt-3">
                  {post.author.socialLinks.twitter && (
                    <a 
                      href={post.author.socialLinks.twitter}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
                      aria-label="Twitter"
                    >
                      <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                      </svg>
                    </a>
                  )}
                  {post.author.socialLinks.linkedin && (
                    <a 
                      href={post.author.socialLinks.linkedin}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
                      aria-label="LinkedIn"
                    >
                      <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                      </svg>
                    </a>
                  )}
                  {post.author.socialLinks.github && (
                    <a 
                      href={post.author.socialLinks.github}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
                      aria-label="GitHub"
                    >
                      <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                      </svg>
                    </a>
                  )}
                  {post.author.socialLinks.website && (
                    <a 
                      href={post.author.socialLinks.website}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
                      aria-label="Website"
                    >
                      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                      </svg>
                    </a>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      <!-- Share Section -->
      <div class="py-8 border-t border-gray-200 dark:border-gray-700">
        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-4">
          Share this article
        </h3>
        <div class="flex items-center gap-3">
          <a
            href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.title)}&url=${encodeURIComponent(Astro.url.href)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="flex items-center gap-2 px-4 py-2 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
          >
            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
            <span class="text-sm font-medium">Tweet</span>
          </a>
          <a
            href={`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(Astro.url.href)}&title=${encodeURIComponent(post.title)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="flex items-center gap-2 px-4 py-2 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
          >
            <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
            </svg>
            <span class="text-sm font-medium">Share</span>
          </a>
          <button
            type="button"
            class="flex items-center gap-2 px-4 py-2 bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors copy-link-btn"
            data-url={Astro.url.href}
          >
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            <span class="text-sm font-medium copy-text">Copy link</span>
          </button>
        </div>
      </div>
    </footer>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <section class="mt-16 py-16 bg-gray-50 dark:bg-gray-800">
        <div class="mx-auto max-w-6xl px-4">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-8">
            Continue Reading
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            {relatedPosts.map((relatedPost) => (
              <BlogCard post={relatedPost} />
            ))}
          </div>
        </div>
      </section>
    )}
  </article>
</BaseLayout>

<script>
  // Copy link functionality
  document.querySelectorAll('.copy-link-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const url = btn.getAttribute('data-url');
      const textEl = btn.querySelector('.copy-text');
      
      if (url && textEl) {
        try {
          await navigator.clipboard.writeText(url);
          textEl.textContent = 'Copied!';
          setTimeout(() => {
            textEl.textContent = 'Copy link';
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      }
    });
  });
</script>

<style>
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
