---
/**
 * Test page for Sanity.io integration
 * This page verifies that the Sanity client is configured correctly
 * and can fetch data from your Sanity dataset.
 *
 * IMPORTANT: Remove this page after verifying the integration works!
 */

import BaseLayout from '@layouts/BaseLayout.astro';
import { getAllPosts, getAllCategories, getFeaturedPosts } from '@lib/sanityQueries';
import { urlFor } from '@lib/sanity';

// Fetch data from Sanity
let posts = [];
let categories = [];
let featuredPosts = [];
let error = null;

try {
  [posts, categories, featuredPosts] = await Promise.all([
    getAllPosts(),
    getAllCategories(),
    getFeaturedPosts(3),
  ]);
} catch (e) {
  error = e instanceof Error ? e.message : 'Unknown error occurred';
  console.error('Sanity fetch error:', e);
}
---

<BaseLayout title="Sanity Integration Test" description="Test page for Sanity.io integration">
  <main class="container mx-auto px-4 py-8 max-w-4xl">
    <h1 class="text-3xl font-bold mb-8">Sanity.io Integration Test</h1>

    {error && (
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
        <strong class="font-bold">Error:</strong>
        <p>{error}</p>
        <p class="mt-2 text-sm">
          Make sure you have:
          <ul class="list-disc list-inside mt-1">
            <li>Set up your <code>.env</code> file with valid Sanity credentials</li>
            <li>Created a Sanity project and dataset</li>
            <li>Published some content in Sanity Studio</li>
          </ul>
        </p>
      </div>
    )}

    {!error && (
      <>
        {/* Connection Status */}
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6">
          <strong class="font-bold">✓ Connected to Sanity!</strong>
          <p class="text-sm mt-1">Your Sanity integration is working correctly.</p>
        </div>

        {/* Environment Info */}
        <section class="mb-8 p-4 bg-gray-100 rounded">
          <h2 class="text-xl font-semibold mb-3">Environment Configuration</h2>
          <dl class="grid grid-cols-2 gap-2 text-sm">
            <dt class="font-medium">Project ID:</dt>
            <dd class="font-mono">{import.meta.env.PUBLIC_SANITY_PROJECT_ID || 'Not set'}</dd>
            <dt class="font-medium">Dataset:</dt>
            <dd class="font-mono">{import.meta.env.PUBLIC_SANITY_DATASET || 'Not set'}</dd>
            <dt class="font-medium">Mode:</dt>
            <dd>{import.meta.env.PROD ? 'Production (CDN enabled)' : 'Development (CDN disabled)'}</dd>
          </dl>
        </section>

        {/* All Posts */}
        <section class="mb-8">
          <h2 class="text-xl font-semibold mb-4">All Posts ({posts.length})</h2>
          {posts.length === 0 ? (
            <p class="text-gray-600 italic">No posts found. Create some content in Sanity Studio!</p>
          ) : (
            <ul class="space-y-4">
              {posts.map((post) => (
                <li class="border rounded p-4 bg-white shadow-sm">
                  <div class="flex gap-4">
                    {post.featuredImage && (
                      <img
                        src={urlFor(post.featuredImage).width(120).height(80).url()}
                        alt={post.featuredImage.alt || post.title}
                        class="w-30 h-20 object-cover rounded"
                      />
                    )}
                    <div class="flex-1">
                      <h3 class="font-semibold text-lg">{post.title}</h3>
                      {post.excerpt && (
                        <p class="text-gray-600 text-sm mt-1">{post.excerpt}</p>
                      )}
                      <div class="flex items-center gap-4 mt-2 text-sm text-gray-500">
                        <span>Slug: <code class="bg-gray-100 px-1">{post.slug.current}</code></span>
                        <span>Published: {new Date(post.publishedAt).toLocaleDateString()}</span>
                      </div>
                      {post.categories && post.categories.length > 0 && (
                        <div class="flex gap-2 mt-2">
                          {post.categories.map((cat) => (
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                              {cat.title}
                            </span>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                </li>
              ))}
            </ul>
          )}
        </section>

        {/* Categories */}
        <section class="mb-8">
          <h2 class="text-xl font-semibold mb-4">Categories ({categories.length})</h2>
          {categories.length === 0 ? (
            <p class="text-gray-600 italic">No categories found.</p>
          ) : (
            <div class="flex flex-wrap gap-2">
              {categories.map((category) => (
                <span class="bg-gray-200 px-3 py-1 rounded-full text-sm">
                  {category.title}
                  {category.description && (
                    <span class="text-gray-500 ml-1">- {category.description}</span>
                  )}
                </span>
              ))}
            </div>
          )}
        </section>

        {/* Featured Posts */}
        <section class="mb-8">
          <h2 class="text-xl font-semibold mb-4">Featured Posts ({featuredPosts.length})</h2>
          {featuredPosts.length === 0 ? (
            <p class="text-gray-600 italic">No featured posts found.</p>
          ) : (
            <div class="grid gap-4 md:grid-cols-3">
              {featuredPosts.map((post) => (
                <div class="border rounded p-3 bg-white shadow-sm">
                  {post.featuredImage && (
                    <img
                      src={urlFor(post.featuredImage).width(300).height(200).url()}
                      alt={post.featuredImage.alt || post.title}
                      class="w-full h-32 object-cover rounded mb-2"
                    />
                  )}
                  <h3 class="font-medium">{post.title}</h3>
                  <p class="text-xs text-gray-500">
                    {new Date(post.publishedAt).toLocaleDateString()}
                  </p>
                </div>
              ))}
            </div>
          )}
        </section>
      </>
    )}

    {/* Removal Notice */}
    <div class="mt-8 p-4 bg-yellow-100 border border-yellow-400 rounded text-yellow-800">
      <strong class="font-bold">⚠️ Note:</strong>
      <p class="text-sm mt-1">
        This is a test page. Remove <code>src/pages/test-sanity.astro</code> after verifying the integration works correctly.
      </p>
    </div>
  </main>
</BaseLayout>
