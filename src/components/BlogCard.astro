---
import { urlFor } from '@lib/sanity';
import type { BlogPostPreview } from '@types/sanity';

interface Props {
  post: BlogPostPreview;
  featured?: boolean;
}

const { post, featured = false } = Astro.props;

// Format date helper
function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

// Calculate reading time (rough estimate: 200 words per minute)
function getReadingTime(excerpt?: string): string {
  if (!excerpt) return '3 min read';
  const words = excerpt.split(/\s+/).length;
  // Assume the full article is about 10x the excerpt length
  const estimatedWords = words * 10;
  const minutes = Math.max(1, Math.round(estimatedWords / 200));
  return `${minutes} min read`;
}

// Get image URL
const imageUrl = post.featuredImage?.asset 
  ? urlFor(post.featuredImage).width(featured ? 1200 : 800).height(featured ? 600 : 450).auto('format').url()
  : null;
---

<article 
  class:list={[
    'group flex flex-col bg-gray-50 dark:bg-gray-800 rounded-2xl overflow-hidden border border-gray-100 dark:border-gray-700',
    'hover:border-gray-200 dark:hover:border-gray-600 transition-all hover:shadow-lg',
    featured && 'md:flex-row'
  ]}
>
  <!-- Post Image -->
  <a 
    href={`/blog/${post.slug?.current || ''}`}
    class:list={[
      'relative overflow-hidden bg-gray-200 dark:bg-gray-700 shrink-0',
      featured ? 'md:w-1/2 aspect-[16/10] md:aspect-auto' : 'aspect-[16/10]'
    ]}
  >
    {imageUrl ? (
      <img 
        src={imageUrl} 
        alt={post.featuredImage?.alt || post.title}
        class="absolute inset-0 w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
        loading="lazy"
      />
    ) : (
      <div class="absolute inset-0 bg-gradient-to-br from-gray-300 to-gray-400 dark:from-gray-600 dark:to-gray-700 flex items-center justify-center">
        <svg class="h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
        </svg>
      </div>
    )}
  </a>
  
  <!-- Post Content -->
  <div class:list={[
    'flex flex-col flex-1 p-6',
    featured && 'md:p-8 md:justify-center'
  ]}>
    <!-- Categories -->
    {post.categories && post.categories.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-3">
        {post.categories.slice(0, 2).map((category) => (
          <a 
            href={`/blog?category=${category.slug?.current || ''}`}
            class="text-xs font-medium text-gray-500 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 px-2.5 py-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
          >
            {category.title}
          </a>
        ))}
      </div>
    )}
    
    <!-- Title -->
    <h3 class:list={[
      'font-semibold text-gray-900 dark:text-white mb-2 group-hover:text-gray-600 dark:group-hover:text-gray-300 transition-colors',
      featured ? 'text-xl md:text-2xl line-clamp-3' : 'text-lg line-clamp-2'
    ]}>
      <a href={`/blog/${post.slug?.current || ''}`}>
        {post.title}
      </a>
    </h3>
    
    <!-- Excerpt -->
    {post.excerpt && (
      <p class:list={[
        'text-gray-600 dark:text-gray-400 mb-4 flex-1',
        featured ? 'text-base line-clamp-3' : 'text-sm line-clamp-2'
      ]}>
        {post.excerpt}
      </p>
    )}
    
    <!-- Meta -->
    <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-500 mt-auto pt-4 border-t border-gray-100 dark:border-gray-700">
      <div class="flex items-center gap-4">
        {/* Author Avatar */}
        {post.author && (
          <div class="flex items-center gap-2">
            {post.author.image?.asset ? (
              <img 
                src={urlFor(post.author.image).width(32).height(32).auto('format').url()}
                alt={post.author.name}
                class="w-6 h-6 rounded-full object-cover"
              />
            ) : (
              <div class="w-6 h-6 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center">
                <span class="text-xs font-medium text-gray-600 dark:text-gray-400">
                  {post.author.name.charAt(0).toUpperCase()}
                </span>
              </div>
            )}
            <span class="hidden sm:inline">{post.author.name}</span>
          </div>
        )}
        
        {/* Date */}
        <time datetime={post.publishedAt}>
          {post.publishedAt && !Number.isNaN(new Date(post.publishedAt).getTime())
            ? formatDate(post.publishedAt)
            : 'â€”'}
        </time>
      </div>
      
      <span class="flex items-center text-gray-400 dark:text-gray-500">
        {getReadingTime(post.excerpt)}
      </span>
    </div>
  </div>
</article>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
