---
interface NavLink {
  href: string;
  label: string;
}

const navLinks: NavLink[] = [
  { href: '/', label: 'Home' },
  { href: '/blog', label: 'Blog' },
  { href: '/about', label: 'About' },
];

const currentPath = Astro.url.pathname;

// Helper to check if a link is active
function isActive(href: string): boolean {
  if (href === '/') {
    return currentPath === '/';
  }
  return currentPath.startsWith(href);
}
---

<nav class="flex items-center">
  {/* Desktop Navigation */}
  <ul class="hidden md:flex items-center gap-6">
    {navLinks.map((link) => (
      <li>
        <a
          href={link.href}
          class:list={[
            'relative py-2 text-sm font-medium transition-colors duration-200',
            isActive(link.href)
              ? 'text-gray-900 dark:text-white'
              : 'text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white',
          ]}
          aria-current={isActive(link.href) ? 'page' : undefined}
        >
          {link.label}
          {isActive(link.href) && (
            <span class="absolute bottom-0 left-0 right-0 h-0.5 bg-gray-900 dark:bg-white rounded-full" />
          )}
        </a>
      </li>
    ))}
  </ul>

  {/* Mobile Menu Button */}
  <button
    id="mobile-menu-button"
    type="button"
    class="md:hidden p-2 -mr-2 text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white transition-colors"
    aria-label="Toggle navigation menu"
    aria-expanded="false"
    aria-controls="mobile-menu"
  >
    <svg
      id="menu-icon-open"
      class="w-6 h-6"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
    </svg>
    <svg
      id="menu-icon-close"
      class="w-6 h-6 hidden"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
      aria-hidden="true"
    >
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>
</nav>

{/* Mobile Menu */}
<div
  id="mobile-menu"
  class="hidden md:hidden absolute top-full left-0 right-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 shadow-lg"
>
  <ul class="flex flex-col py-4 px-4">
    {navLinks.map((link) => (
      <li>
        <a
          href={link.href}
          class:list={[
            'block py-3 px-4 rounded-lg text-base font-medium transition-colors duration-200',
            isActive(link.href)
              ? 'text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-800'
              : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-800',
          ]}
          aria-current={isActive(link.href) ? 'page' : undefined}
        >
          {link.label}
        </a>
      </li>
    ))}
  </ul>
</div>

<script>
  let mobileMenuInitialized = false;
  let documentClickHandler: ((e: MouseEvent) => void) | null = null;
  let documentKeydownHandler: ((e: KeyboardEvent) => void) | null = null;

  function initMobileMenu() {
    const button = document.getElementById('mobile-menu-button');
    const menu = document.getElementById('mobile-menu');
    const iconOpen = document.getElementById('menu-icon-open');
    const iconClose = document.getElementById('menu-icon-close');

    if (!button || !menu || !iconOpen || !iconClose) return;

    // Remove existing document-level listeners if they exist
    if (documentClickHandler) {
      document.removeEventListener('click', documentClickHandler);
    }
    if (documentKeydownHandler) {
      document.removeEventListener('keydown', documentKeydownHandler);
    }

    let isOpen = false;

    function toggleMenu() {
      isOpen = !isOpen;
      menu.classList.toggle('hidden', !isOpen);
      iconOpen.classList.toggle('hidden', isOpen);
      iconClose.classList.toggle('hidden', !isOpen);
      button.setAttribute('aria-expanded', String(isOpen));
    }

    // Only add button listener on first init (button is replaced on swap)
    button.addEventListener('click', toggleMenu);

    // Close menu when clicking outside
    documentClickHandler = (e: MouseEvent) => {
      if (isOpen && !button.contains(e.target as Node) && !menu.contains(e.target as Node)) {
        toggleMenu();
      }
    };
    document.addEventListener('click', documentClickHandler);

    // Close menu on escape key
    documentKeydownHandler = (e: KeyboardEvent) => {
      if (isOpen && e.key === 'Escape') {
        toggleMenu();
        button.focus();
      }
    };
    document.addEventListener('keydown', documentKeydownHandler);

    // Close menu when navigating (for SPA-like behavior)
    menu.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => {
        if (isOpen) toggleMenu();
      });
    });

    mobileMenuInitialized = true;
  }

  // Initialize on page load
  initMobileMenu();

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:after-swap', initMobileMenu);
</script>
